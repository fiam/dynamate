name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing git tag to release (for example: v0.1.0)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always
  GH_OWNER: fiam
  HOMEBREW_TAP_REPO_NAME: homebrew-dynamate
  GHCR_IMAGE_NAME: dynamate

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Resolve release tag
        id: meta
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            tag="${{ inputs.tag }}"
          else
            tag="${GITHUB_REF_NAME}"
          fi

          if [[ ! "${tag}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.]+)?$ ]]; then
            echo "::error::Tag must look like v1.2.3 or v1.2.3-rc1. Got '${tag}'."
            exit 1
          fi

          version="${tag#v}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"

  build:
    name: Build ${{ matrix.target }}
    needs: prepare
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: dynamate
            archive_ext: tar.gz
          - os: macos-15-intel
            target: x86_64-apple-darwin
            binary_name: dynamate
            archive_ext: tar.gz
          - os: macos-15
            target: aarch64-apple-darwin
            binary_name: dynamate
            archive_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: dynamate.exe
            archive_ext: zip

    env:
      VERSION: ${{ needs.prepare.outputs.version }}
      TARGET: ${{ matrix.target }}
      BINARY_NAME: ${{ matrix.binary_name }}

    steps:
      - name: Checkout source at release tag
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.93.0
          targets: ${{ matrix.target }}

      - name: Cache cargo artifacts
        uses: swatinem/rust-cache@v2

      - name: Build release binary
        run: cargo build --release --locked --target "${TARGET}"

      - name: Package artifact (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          archive_name="dynamate-${VERSION}-${TARGET}.${{ matrix.archive_ext }}"
          staging_dir="dist/staging/dynamate-${VERSION}-${TARGET}"
          mkdir -p "${staging_dir}"

          cp "target/${TARGET}/release/${BINARY_NAME}" "${staging_dir}/dynamate"
          cp README.md "${staging_dir}/README.md"
          if [[ -f LICENSE ]]; then
            cp LICENSE "${staging_dir}/LICENSE"
          fi

          tar -C dist/staging -czf "dist/${archive_name}" "dynamate-${VERSION}-${TARGET}"

      - name: Package artifact (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $archiveName = "dynamate-$env:VERSION-$env:TARGET.${{ matrix.archive_ext }}"
          $stagingDir = "dist/staging/dynamate-$env:VERSION-$env:TARGET"
          New-Item -ItemType Directory -Path $stagingDir -Force | Out-Null

          Copy-Item "target/$env:TARGET/release/$env:BINARY_NAME" "$stagingDir/dynamate.exe"
          Copy-Item "README.md" "$stagingDir/README.md"
          if (Test-Path "LICENSE") {
            Copy-Item "LICENSE" "$stagingDir/LICENSE"
          }

          Compress-Archive -Path "$stagingDir/*" -DestinationPath "dist/$archiveName" -Force

      - name: Upload archive artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.target }}
          path: dist/dynamate-${{ env.VERSION }}-${{ matrix.target }}.${{ matrix.archive_ext }}
          if-no-files-found: error

  release:
    name: Publish GitHub release
    needs:
      - prepare
      - build
    runs-on: ubuntu-latest

    steps:
      - name: Download archives
        uses: actions/download-artifact@v7
        with:
          pattern: dist-*
          path: dist
          merge-multiple: true

      - name: Generate checksums
        shell: bash
        run: |
          cd dist
          sha256sum * > SHA256SUMS.txt

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/*

  homebrew:
    name: Publish Homebrew formula
    needs:
      - prepare
      - release
    runs-on: ubuntu-latest
    if: ${{ secrets.HOMEBREW_TAP_TOKEN != '' }}

    steps:
      - name: Download archives
        uses: actions/download-artifact@v7
        with:
          pattern: dist-*
          path: dist
          merge-multiple: true

      - name: Compute macOS checksums
        id: sums
        shell: bash
        run: |
          version="${{ needs.prepare.outputs.version }}"
          arm_archive="dynamate-${version}-aarch64-apple-darwin.tar.gz"
          x64_archive="dynamate-${version}-x86_64-apple-darwin.tar.gz"

          for archive in "${arm_archive}" "${x64_archive}"; do
            if [[ ! -f "dist/${archive}" ]]; then
              echo "::error::Missing expected archive dist/${archive}"
              exit 1
            fi
          done

          arm_sha="$(sha256sum "dist/${arm_archive}" | cut -d' ' -f1)"
          x64_sha="$(sha256sum "dist/${x64_archive}" | cut -d' ' -f1)"

          echo "arm_sha=${arm_sha}" >> "${GITHUB_OUTPUT}"
          echo "x64_sha=${x64_sha}" >> "${GITHUB_OUTPUT}"

      - name: Checkout Homebrew tap
        uses: actions/checkout@v6
        with:
          repository: ${{ format('{0}/{1}', env.GH_OWNER, env.HOMEBREW_TAP_REPO_NAME) }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Write formula
        shell: bash
        run: |
          tag="${{ needs.prepare.outputs.tag }}"
          version="${{ needs.prepare.outputs.version }}"
          repo="${{ github.repository }}"
          arm_sha="${{ steps.sums.outputs.arm_sha }}"
          x64_sha="${{ steps.sums.outputs.x64_sha }}"

          mkdir -p tap/Formula
          cat > tap/Formula/dynamate.rb <<EOF
          class Dynamate < Formula
            desc "Terminal UI for DynamoDB exploration and querying"
            homepage "https://github.com/${repo}"
            version "${version}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${repo}/releases/download/${tag}/dynamate-${version}-aarch64-apple-darwin.tar.gz"
                sha256 "${arm_sha}"
              else
                url "https://github.com/${repo}/releases/download/${tag}/dynamate-${version}-x86_64-apple-darwin.tar.gz"
                sha256 "${x64_sha}"
              end
            end

            def install
              bin.install "dynamate"
            end

            test do
              assert_match "Usage:", shell_output("#{bin}/dynamate --help")
            end
          end
          EOF

      - name: Commit and push formula
        shell: bash
        run: |
          cd tap
          tag="${{ needs.prepare.outputs.tag }}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/dynamate.rb

          if git diff --cached --quiet; then
            echo "Formula already up to date."
            exit 0
          fi

          git commit -m "chore: update dynamate ${tag}"
          git push

  docker:
    name: Publish Docker image
    needs:
      - prepare
      - release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source at release tag
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.GH_OWNER }}/${{ env.GHCR_IMAGE_NAME }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.tag }}
            type=raw,value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ !contains(needs.prepare.outputs.version, '-') }}
          labels: |
            org.opencontainers.image.title=dynamate
            org.opencontainers.image.description=Your DynamoDB table mate
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
