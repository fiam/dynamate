# Releasing

## Workflows

- Version/tag workflow: [`.github/workflows/create-release.yml`](../.github/workflows/create-release.yml)
- Dist release workflow:
  [`.github/workflows/release.yml`](../.github/workflows/release.yml)
  (autogenerated by `cargo-dist`)
- Docker reusable workflow:
  [`.github/workflows/docker.yml`](../.github/workflows/docker.yml)
  (called by dist as a post-announce job)
- Changelog reusable workflow:
  [`.github/workflows/changelog.yml`](../.github/workflows/changelog.yml)
  (called by dist as a post-announce job)

## cargo-dist configuration

- Root dist config: [`dist-workspace.toml`](../dist-workspace.toml)
- Package opt-in: `[package.metadata.dist]` in [`Cargo.toml`](../Cargo.toml)
- Dist build profile: `[profile.dist]` in [`Cargo.toml`](../Cargo.toml)

Do not edit [`.github/workflows/release.yml`](../.github/workflows/release.yml) by hand. Regenerate it with:

```bash
dist generate --mode ci
```

## Repositories required

1. Main source repository (this repository).
2. Homebrew tap repository, usually `${GH_OWNER}/${HOMEBREW_TAP_REPO_NAME}`.

The tap repository must contain a `Formula/` directory. The release workflow writes `Formula/dynamate.rb`.

## Release constants

Set once in [`dist-workspace.toml`](../dist-workspace.toml):

1. `tap = "fiam/homebrew-dynamate"`
2. `post-announce-jobs = ["./docker", "./changelog"]`

## Secrets required in source repository

Set these in `Settings -> Secrets and variables -> Actions`:

1. `HOMEBREW_TAP_TOKEN`
Fine-grained PAT with `Contents: Read and write` access to the tap repository.

No extra secret is needed for GHCR publishing. Docker publishing uses `GITHUB_TOKEN`.

## Permissions required

- Actions `GITHUB_TOKEN` should have repository read/write permissions.
- Dist workflow requests `contents: write`.
- [`create-release.yml`](../.github/workflows/create-release.yml) also requires
  `actions: write` to dispatch
  [`release.yml`](../.github/workflows/release.yml).
- Docker post-announce job requests `packages: write`.

## Release process

1. Trigger `Bump, Tag, and Dispatch Release`
   ([`.github/workflows/create-release.yml`](../.github/workflows/create-release.yml))
   with:
   - `ref`: branch to release from (default `main`)
   - `bump`: `patch`, `minor`, `major`, or `exact`
   - `version`: only required when `bump=exact` (e.g. `0.2.0` or `v0.2.0`)
2. The workflow validates branch/version input and ensures the computed tag does not already exist.
3. It bumps [`Cargo.toml`](../Cargo.toml)/[`Cargo.lock`](../Cargo.lock) using `cargo release version ... --execute`.
4. It runs release gate checks:
   - `cargo fmt --all -- --check`
   - `cargo check --all-targets --all-features`
   - `cargo clippy --all-targets --all-features -- -D warnings`
   - `cargo test --all-targets --all-features`
5. It commits the bump, creates annotated tag `vX.Y.Z`, and pushes branch + tag.
6. It dispatches [`.github/workflows/release.yml`](../.github/workflows/release.yml) with the tag input.
7. The dist workflow plans/builds/hosts release artifacts and updates Homebrew (when token is present).
8. Dist runs post-announce job
   [`./docker`](../.github/workflows/docker.yml), which builds and pushes
   multi-arch GHCR images.
9. Dist runs post-announce job
   [`./changelog`](../.github/workflows/changelog.yml), which updates the
   release notes from Conventional Commit subjects between tags.

## Artifacts produced

- `dynamate-aarch64-apple-darwin.tar.gz`
- `dynamate-aarch64-unknown-linux-gnu.tar.gz`
- `dynamate-x86_64-apple-darwin.tar.gz`
- `dynamate-x86_64-unknown-linux-gnu.tar.gz`
- `dynamate-x86_64-pc-windows-msvc.zip`
- `source.tar.gz`, checksums, and generated Homebrew formula
- Docker image `ghcr.io/<owner>/dynamate:<tag>`
- Docker image `ghcr.io/<owner>/dynamate:<version>`
- Docker image `ghcr.io/<owner>/dynamate:latest` (non-prerelease only)
- GitHub release notes prefixed with an auto-generated Conventional-Commits changelog

## Manual release trigger

You can run `Release` manually for an existing tag by setting workflow dispatch input `tag` to that tag.
